@page "/question"
@inject GameEngine GameEngine
@inject NavigationManager Nav
@inject SettingsService SettingsService
@inject ProfileService ProfileService
@implements IDisposable

<div class="container">
@if (GameEngine.CurrentQuestion is null || GameEngine.CurrentSession is null || GameEngine.CurrentSession.IsComplete)
{
    <p class="text-muted">No active game. <a href="./">Return to title.</a></p>
}
else
{
    <div class="main-card">
        <div class="progress-row">
            <strong>Question @((GameEngine.CurrentSession.CurrentIndex + 1)) / @GameEngine.CurrentSession.Questions.Count</strong>
            <div class="progress-bar">
                <span style="width:@ProgressWidth%"></span>
            </div>
            <div class="meta-chip"><img class="icon" src="@AssetCatalog.GetAssetPath("heartico.png")" alt="Lives" /> @GameEngine.CurrentSession.Lives</div>
            <div class="meta-chip"><img class="icon" src="@AssetCatalog.GetAssetPath("coinico.png")" alt="Coins" /> @ProfileService.Current.Coins</div>
            <div class="meta-chip"><img class="icon" src="@AssetCatalog.GetIdolIcon(ProfileService.Current.IdolLevel)" alt="Idol" /> Idol Tier</div>
        </div>

        <div class="question-header">
            <img class="icon" src="@AssetCatalog.GetAssetPath("lightbuilb-face.png")" alt="Hint" />
            <h3>@GameEngine.CurrentQuestion.Prompt</h3>
            <img class="idol-small" src="@AssetCatalog.GetIdolIcon(ProfileService.Current.IdolLevel)" alt="Idol" />
        </div>

        <div class="choice-grid">
            @for (var i = 0; i < GameEngine.CurrentQuestion.Choices.Count; i++)
            {
                var choice = GameEngine.CurrentQuestion.Choices[i];
                var disabled = _answered || GameEngine.HiddenChoices.Contains(i);
                var classes = "choice-button";
                if (_answered && i == GameEngine.CurrentQuestion.AnswerIndex)
                {
                    classes += " correct";
                }
                else if (_answered && i == _selectedIndex && !_wasCorrect)
                {
                    classes += " incorrect";
                }

                <button class="@classes" disabled="@disabled" @onclick="() => Submit(i)">
                    <span>@choice</span>
                    @if (_answered && i == GameEngine.CurrentQuestion.AnswerIndex)
                    {
                        <img class="result-icon" src="@AssetCatalog.GetAssetPath("correct.png")" alt="Correct" />
                    }
                    else if (_answered && i == _selectedIndex && !_wasCorrect)
                    {
                        <img class="result-icon" src="@AssetCatalog.GetAssetPath("incorrect.png")" alt="Incorrect" />
                    }
                </button>
            }
        </div>

        <div class="action-buttons">
            <button class="action-button" @onclick="UseSkip" disabled="@_answered">
                <img src="@AssetCatalog.GetAssetPath("5050.png")" alt="50-50" />
            </button>
            <button class="action-button" @onclick="Next" disabled="@(!_answered)">
                <img src="@AssetCatalog.GetAssetPath(_isLastQuestion ? "end-trivia-button.png" : "next button.png")" alt="Next" />
            </button>
        </div>

        <div class="helper-row">
            <img class="icon" src="@AssetCatalog.GetAssetPath("warning.png")" alt="Report" />
            <a href="feedback" class="text-muted">Report a question</a>
        </div>
    </div>
}
</div>

@code {
    private bool _answered;
    private bool _wasCorrect;
    private bool _initialized;
    private int _selectedIndex = -1;

    private double ProgressWidth => GameEngine.CurrentSession is { Questions.Count: > 0 } session
        ? ((double)session.CurrentIndex / session.Questions.Count) * 100
        : 0;

    private bool _isLastQuestion => GameEngine.CurrentSession is not null && GameEngine.CurrentSession.CurrentIndex + 1 >= GameEngine.CurrentSession.Questions.Count;

    protected override async Task OnInitializedAsync()
    {
        await EnsureLoadedAsync();
        GameEngine.StateChanged += OnChanged;
        if (GameEngine.CurrentSession is null)
        {
            await GameEngine.StartGameAsync();
        }
    }

    private async Task EnsureLoadedAsync()
    {
        if (_initialized) return;
        await SettingsService.InitializeAsync();
        await ProfileService.InitializeAsync();
        _initialized = true;
    }

    private void OnChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void Submit(int index)
    {
        _selectedIndex = index;
        _answered = true;
        _wasCorrect = GameEngine.SubmitAnswer(index);
    }

    private void UseSkip()
    {
        GameEngine.UseSkip();
    }

    private async Task Next()
    {
        await GameEngine.NextQuestionAsync();
        _answered = false;
        _selectedIndex = -1;
        _wasCorrect = false;
        if (GameEngine.CurrentSession?.IsComplete == true)
        {
            Nav.NavigateTo("/score");
        }
    }

    public void Dispose()
    {
        GameEngine.StateChanged -= OnChanged;
    }
}
