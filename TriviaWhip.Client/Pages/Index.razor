@page "/"
@inject SettingsService SettingsService
@inject ProfileService ProfileService
@inject GameEngine GameEngine
@inject NavigationManager Nav
@implements IDisposable

<div class="container">
<div class="title-hero" style="background-image:url('@_titleBackground')">
    <div class="title-overlay">
        <div class="hero-meta">
            <img class="avatar-display" src="@AvatarImage" alt="Selected avatar" />
            <div>
                <div class="hero-title">Trivia Whip</div>
                <div class="hero-subtitle">@ProfileService.Current.Level.ToString("N0") XP Level â€¢ @_progressLabel</div>
                <div class="buff-strip">
                    <img src="@IdolIcon" class="idol-icon" alt="Idol" title="Current idol" />
                    @foreach (var buffIcon in BuffIcons)
                    {
                        <img src="@buffIcon" class="buff-icon" alt="Equipped buff" />
                    }
                </div>
            </div>
        </div>
        <button class="play-button" @onclick="StartGame">
            <img src="@AssetCatalog.GetAssetPath("play-button.png")" alt="Play" />
        </button>
    </div>
</div>

<div class="main-card">
    <div class="stat-grid">
        <div class="stat-card">
            <strong>Coins</strong>
            <div class="stat-row">
                <img class="icon" src="@AssetCatalog.GetAssetPath("coinico.png")" alt="Coins" />
                <span>@ProfileService.Current.Coins</span>
            </div>
        </div>
        <div class="stat-card">
            <strong>Progress</strong>
            <div class="progress-bar" title="Progress to next milestone">
                <span style="width:@ProgressPercent%"></span>
            </div>
            <p class="text-muted">@ProfileService.Current.CorrectCount <img class="inline-icon" src="@AssetCatalog.GetAssetPath("slash.png")" alt="/" /> @NextMilestone</p>
        </div>
        <div class="stat-card">
            <strong>Timer Mode</strong>
            <div class="stat-row">
                <img class="icon" src="@AssetCatalog.GetAssetPath(SettingsService.Current.TimerMode ? "timedmode.png" : "question-mark.png")" alt="Timer" />
                <span>@(SettingsService.Current.TimerMode ? "Enabled" : "Off")</span>
            </div>
        </div>
    </div>

    <div class="button-bar" style="margin-top:1rem;">
        <button class="secondary-button" @onclick="@(() => Nav.NavigateTo("/categories"))">
            <img class="icon" src="@AssetCatalog.GetAssetPath("categoryview.png")" alt="Categories" />
            Categories
        </button>
        <button class="secondary-button" @onclick="@(() => Nav.NavigateTo("/store"))">
            <img class="icon" src="@AssetCatalog.GetAssetPath("store.png")" alt="Store" />
            Store
        </button>
        <button class="secondary-button" @onclick="@(() => Nav.NavigateTo("/settings"))">
            <img class="icon" src="@AssetCatalog.GetAssetPath("settings.png")" alt="Settings" />
            Settings
        </button>
    </div>

    <div class="stat-grid" style="margin-top:1rem;">
        <div class="stat-card">
            <strong>Selected Categories</strong>
            <div class="tag-row">
                @foreach (var category in SettingsService.Current.CategoriesSelected.DefaultIfEmpty("All"))
                {
                    var label = GetCategoryLabel(category);
                    <span class="tag-pill">
                        <img class="icon" src="@AssetCatalog.GetMainCategoryIcon(category)" alt="Category icon" />
                        @label
                    </span>
                }
            </div>
        </div>
        <div class="stat-card">
            <strong>Question Count</strong>
            <div class="stat-row">
                <img class="icon" src="@AssetCatalog.GetAssetPath("levellabel.png")" alt="Question count" />
                <span>@SettingsService.Current.QuestionCount</span>
            </div>
        </div>
        <div class="stat-card">
            <strong>Achievements</strong>
            <div class="stat-row">
                <img class="icon" src="@AssetCatalog.GetAssetPath("trophy.png")" alt="Achievements" />
                <span>@ProfileService.Current.BestStreak.ToString("N0") best streak</span>
            </div>
        </div>
    </div>
</div>
</div>

@code {
    private bool _initialized;
    private string _titleBackground = AssetCatalog.GetAssetPath(AssetCatalog.TitleBackgrounds.First());

    private int NextMilestone => ProfileService.Current.Milestones.FirstOrDefault(m => m > ProfileService.Current.CorrectCount,
ProfileService.Current.Milestones.LastOrDefault(300));
    private int ProgressPercent => NextMilestone == 0 ? 100 : (int)(Math.Min(1, (double)ProfileService.Current.CorrectCount / NextMilestone) * 100);
    private string AvatarImage => AssetCatalog.GetAvatar(SettingsService.Current.Avatar);
    private string IdolIcon => AssetCatalog.GetIdolIcon(ProfileService.Current.IdolLevel);
    private string _progressLabel => $"{ProfileService.Current.CorrectCount}/{NextMilestone} correct";
    private IEnumerable<string> BuffIcons => ProfileService.Current.OwnedBuffs.Any()
        ? ProfileService.Current.OwnedBuffs.Select(AssetCatalog.GetBuffIcon)
        : new[] { AssetCatalog.GetAssetPath("add buff.png") };

    private static string GetCategoryLabel(string slug)
    {
        if (string.IsNullOrWhiteSpace(slug) || slug.Equals("all", StringComparison.OrdinalIgnoreCase))
        {
            return "All";
        }

        return slug.Contains("__", StringComparison.Ordinal)
            ? CategoryCatalog.GetSubcategoryDisplay(slug)
            : CategoryCatalog.GetCategoryDisplay(slug);
    }

    protected override async Task OnInitializedAsync()
    {
        await EnsureLoadedAsync();
        GameEngine.StateChanged += OnChanged;
        var rng = new Random();
        _titleBackground = AssetCatalog.GetRandomTitleBackground(rng);
    }

    private async Task EnsureLoadedAsync()
    {
        if (_initialized) return;
        await SettingsService.InitializeAsync();
        await ProfileService.InitializeAsync();
        _initialized = true;
    }

    private async Task StartGame()
    {
        await EnsureLoadedAsync();
        await GameEngine.StartGameAsync();
        if (GameEngine.CurrentSession is { IsComplete: false })
        {
            Nav.NavigateTo("/question");
        }
    }

    private void OnChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        GameEngine.StateChanged -= OnChanged;
    }
}
